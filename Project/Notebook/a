{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "b9885e0b",
   "metadata": {},
   "source": [
    "# 01 – Data Collection and Panel Construction\n",
    "\n",
    "This notebook builds the raw and processed datasets used in the project:\n",
    "\n",
    "- Sets up the project folder structure (`data/raw/`, `data/processed/`)\n",
    "- Loads Eurostat, OECD (CCI), and Statcounter exports\n",
    "- Cleans and harmonises country codes and dates\n",
    "- Constructs:\n",
    "  - A monthly macro–social-media panel for **H3** (`panel_monthly_h3.csv`)\n",
    "  - A final annual country × year macro panel for **H1–H2** (`panel_annual.csv`)\n",
    "\n",
    "All paths assume the project folder is located at `~/Desktop/DSA210`."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3795cd5d",
   "metadata": {},
   "source": [
    "## CELL 1 – Project directories\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "ffe6e7ee",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "PROJECT_ROOT   : /Users/ibrahimgozlukaya/Desktop/DSA210\n",
      "DATA_RAW       : /Users/ibrahimgozlukaya/Desktop/DSA210/data/raw\n",
      "DATA_PROCESSED : /Users/ibrahimgozlukaya/Desktop/DSA210/data/processed\n"
     ]
    }
   ],
   "source": [
    "\n",
    "from pathlib import Path\n",
    "\n",
    "# ------------------------------------------------------------------\n",
    "# Project root (adjust if your folder is elsewhere)\n",
    "# ------------------------------------------------------------------\n",
    "PROJECT_ROOT = Path.home() / \"Desktop\" / \"DSA210\"\n",
    "\n",
    "DATA_RAW       = PROJECT_ROOT / \"data\" / \"raw\"\n",
    "DATA_PROCESSED = PROJECT_ROOT / \"data\" / \"processed\"\n",
    "\n",
    "DATA_RAW.mkdir(parents=True, exist_ok=True)\n",
    "DATA_PROCESSED.mkdir(parents=True, exist_ok=True)\n",
    "\n",
    "print(\"PROJECT_ROOT   :\", PROJECT_ROOT)\n",
    "print(\"DATA_RAW       :\", DATA_RAW)\n",
    "print(\"DATA_PROCESSED :\", DATA_PROCESSED)\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1e66ec22",
   "metadata": {},
   "source": [
    "## CELL 2 – Statcounter setup: country mapping & URL template\n",
    "\n",
    "This cell defines the mapping from Eurostat `geo` codes to Statcounter URL\n",
    "slugs and the helper function that turns the Spain template URL into a\n",
    "country-specific Statcounter download link."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "708753ed",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "import os\n",
    "import io\n",
    "import requests\n",
    "\n",
    "# Mapping: Eurostat geo code → Statcounter slug + display name\n",
    "tries = {\n",
    "    \"AL\": {\"slug\": \"albania\", \"name_in_url\": \"Albania\"},\n",
    "    \"AT\": {\"slug\": \"austria\", \"name_in_url\": \"Austria\"},\n",
    "    \"BA\": {\"slug\": \"bosnia-and-herzegovina\", \"name_in_url\": \"Bosnia and Herzegovina\"},\n",
    "    \"BE\": {\"slug\": \"belgium\", \"name_in_url\": \"Belgium\"},\n",
    "    \"BG\": {\"slug\": \"bulgaria\", \"name_in_url\": \"Bulgaria\"},\n",
    "    \"CH\": {\"slug\": \"switzerland\", \"name_in_url\": \"Switzerland\"},\n",
    "    \"CY\": {\"slug\": \"cyprus\", \"name_in_url\": \"Cyprus\"},\n",
    "    \"CZ\": {\"slug\": \"czech-republic\", \"name_in_url\": \"Czech Republic\"},\n",
    "    \"DE\": {\"slug\": \"germany\", \"name_in_url\": \"Germany\"},\n",
    "    \"DK\": {\"slug\": \"denmark\", \"name_in_url\": \"Denmark\"},\n",
    "    \"EE\": {\"slug\": \"estonia\", \"name_in_url\": \"Estonia\"},\n",
    "    \"EL\": {\"slug\": \"greece\", \"name_in_url\": \"Greece\"},\n",
    "    \"ES\": {\"slug\": \"spain\", \"name_in_url\": \"Spain\"},\n",
    "    \"FI\": {\"slug\": \"finland\", \"name_in_url\": \"Finland\"},\n",
    "    \"FR\": {\"slug\": \"france\", \"name_in_url\": \"France\"},\n",
    "    \"HR\": {\"slug\": \"croatia\", \"name_in_url\": \"Croatia\"},\n",
    "    \"HU\": {\"slug\": \"hungary\", \"name_in_url\": \"Hungary\"},\n",
    "    \"IE\": {\"slug\": \"ireland\", \"name_in_url\": \"Ireland\"},\n",
    "    \"IS\": {\"slug\": \"iceland\", \"name_in_url\": \"Iceland\"},\n",
    "    \"IT\": {\"slug\": \"italy\", \"name_in_url\": \"Italy\"},\n",
    "    \"LT\": {\"slug\": \"lithuania\", \"name_in_url\": \"Lithuania\"},\n",
    "    \"LU\": {\"slug\": \"luxembourg\", \"name_in_url\": \"Luxembourg\"},\n",
    "    \"LV\": {\"slug\": \"latvia\", \"name_in_url\": \"Latvia\"},\n",
    "    \"ME\": {\"slug\": \"montenegro\", \"name_in_url\": \"Montenegro\"},\n",
    "    \"MK\": {\"slug\": \"north-macedonia\", \"name_in_url\": \"North Macedonia\"},\n",
    "    \"MT\": {\"slug\": \"malta\", \"name_in_url\": \"Malta\"},\n",
    "    \"NL\": {\"slug\": \"netherlands\", \"name_in_url\": \"Netherlands\"},\n",
    "    \"NO\": {\"slug\": \"norway\", \"name_in_url\": \"Norway\"},\n",
    "    \"PL\": {\"slug\": \"poland\", \"name_in_url\": \"Poland\"},\n",
    "    \"PT\": {\"slug\": \"portugal\", \"name_in_url\": \"Portugal\"},\n",
    "    \"RO\": {\"slug\": \"romania\", \"name_in_url\": \"Romania\"},\n",
    "    \"RS\": {\"slug\": \"serbia\", \"name_in_url\": \"Serbia\"},\n",
    "    \"SE\": {\"slug\": \"sweden\", \"name_in_url\": \"Sweden\"},\n",
    "    \"SI\": {\"slug\": \"slovenia\", \"name_in_url\": \"Slovenia\"},\n",
    "    \"SK\": {\"slug\": \"slovakia\", \"name_in_url\": \"Slovakia\"},\n",
    "    \"TR\": {\"slug\": \"turkey\", \"name_in_url\": \"Turkey\"},\n",
    "    \"UK\": {\"slug\": \"united-kingdom\", \"name_in_url\": \"United Kingdom\"},\n",
    "    \"XK\": {\"slug\": \"kosovo\", \"name_in_url\": \"Kosovo\"},\n",
    "}\n",
    "\n",
    "# Spain template URL for Statcounter – we will replace Spain-specific bits.\n",
    "template_url = (\n",
    "    \"https://gs.statcounter.com/social-media-stats/all/spain/chart.php\"\n",
    "    \"?device=Desktop%20%26%20Mobile%20%26%20Tablet%20%26%20Console\"\n",
    "    \"&device_hidden=desktop%2Bmobile%2Btablet%2Bconsole\"\n",
    "    \"&multi-device=true\"\n",
    "    \"&statType_hidden=social_media\"\n",
    "    \"&region_hidden=ES\"\n",
    "    \"&granularity=monthly\"\n",
    "    \"&statType=Social%20Media\"\n",
    "    \"&region=Spain\"\n",
    "    \"&fromInt=201010\"\n",
    "    \"&toInt=202510\"\n",
    "    \"&fromMonthYear=2010-10\"\n",
    "    \"&toMonthYear=2025-10\"\n",
    "    \"&csv=1\"\n",
    ")\n",
    "\n",
    "def build_url(geo_code: str, slug: str, name_in_url: str) -> str:\n",
    "    \"\"\"Return a country-specific Statcounter CSV download URL.\"\"\"\n",
    "    url = template_url\n",
    "    url = url.replace(\"/spain/\", f\"/{slug}/\")\n",
    "    url = url.replace(\"region_hidden=ES\", f\"region_hidden={geo_code}\")\n",
    "    url = url.replace(\"region=Spain\", f\"region={name_in_url}\")\n",
    "    return url\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5b6d141a",
   "metadata": {},
   "source": [
    "## CELL 3 – Download merged monthly Statcounter panel\n",
    "\n",
    "Loops over all countries in `tries`, downloads the Statcounter CSV, adds\n",
    "`geo` and `country_name`, concatenates everything, and saves a single\n",
    "merged file to `data/processed/social_media_countries_monthly.csv`."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "eb7f2510",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "AL → albania\n",
      "AT → austria\n",
      "BA → bosnia-and-herzegovina\n",
      "BE → belgium\n",
      "BG → bulgaria\n",
      "CH → switzerland\n",
      "CY → cyprus\n",
      "CZ → czech-republic\n",
      "DE → germany\n",
      "DK → denmark\n",
      "EE → estonia\n",
      "EL → greece\n",
      "ES → spain\n",
      "FI → finland\n",
      "FR → france\n",
      "HR → croatia\n",
      "HU → hungary\n",
      "IE → ireland\n",
      "IS → iceland\n",
      "IT → italy\n",
      "LT → lithuania\n",
      "LU → luxembourg\n",
      "LV → latvia\n",
      "ME → montenegro\n",
      "MK → north-macedonia\n",
      "MT → malta\n",
      "NL → netherlands\n",
      "NO → norway\n",
      "PL → poland\n",
      "PT → portugal\n",
      "RO → romania\n",
      "RS → serbia\n",
      "SE → sweden\n",
      "SI → slovenia\n",
      "SK → slovakia\n",
      "TR → turkey\n",
      "UK → united-kingdom\n",
      "XK → kosovo\n",
      "\n",
      "✅ Saved merged Statcounter panel: /Users/ibrahimgozlukaya/Desktop/DSA210/data/processed/social_media_countries_monthly.csv\n",
      "Rows: 6878\n"
     ]
    }
   ],
   "source": [
    "\n",
    "import pandas as pd\n",
    "\n",
    "all_frames = []\n",
    "\n",
    "for geo, info in tries.items():\n",
    "    slug = info[\"slug\"]\n",
    "    name_in_url = info[\"name_in_url\"]\n",
    "\n",
    "    url = build_url(geo, slug, name_in_url)\n",
    "    print(f\"{geo} → {slug}\")\n",
    "\n",
    "    try:\n",
    "        r = requests.get(url, timeout=30)\n",
    "        r.raise_for_status()\n",
    "    except Exception as e:\n",
    "        print(f\"❌ Connection error for {geo}: {e}\")\n",
    "        continue\n",
    "\n",
    "    try:\n",
    "        df = pd.read_csv(io.StringIO(r.text))\n",
    "        df[\"geo\"] = geo\n",
    "        df[\"country_name\"] = name_in_url\n",
    "        all_frames.append(df)\n",
    "    except Exception as e:\n",
    "        print(f\"❌ CSV parsing failed for {geo}: {e}\")\n",
    "\n",
    "if all_frames:\n",
    "    panel = pd.concat(all_frames, ignore_index=True)\n",
    "    out_path = DATA_PROCESSED / \"social_media_countries_monthly.csv\"\n",
    "    panel.to_csv(out_path, index=False)\n",
    "    print(\"\\n✅ Saved merged Statcounter panel:\", out_path)\n",
    "    print(\"Rows:\", len(panel))\n",
    "else:\n",
    "    print(\"❌ No Statcounter CSV could be parsed.\")\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7bedf2c6",
   "metadata": {},
   "source": [
    "## CELL 4 – Build monthly macro + platform panel for H3\n",
    "\n",
    "This cell merges:\n",
    "- Monthly unemployment (Eurostat `une_rt_m_linear_2_0.csv`)\n",
    "- Monthly HICP price index (Eurostat `prc_hicp_midx__custom_19134087_linear.csv`)\n",
    "- Monthly Statcounter platform shares (the merged file from **Cell 3**)\n",
    "\n",
    "It outputs `data/processed/panel_monthly_h3.csv` with:\n",
    "- `ent_share` (entertainment platforms: Facebook, Instagram, YouTube)\n",
    "- `prof_share` (professional platform: LinkedIn)\n",
    "- first differences of unemployment, inflation index, and platform shares\n",
    "  (`d_unemp`, `d_infl`, `d_ent`, `d_prof`)."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "a969f80e",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "RAW: /Users/ibrahimgozlukaya/Desktop/DSA210/data/raw\n",
      "PROCESSED: /Users/ibrahimgozlukaya/Desktop/DSA210/data/processed\n",
      "Unemployment monthly rows: 727293\n",
      "HICP date min: 2008 HICP date max: 2025\n",
      "HICP monthly rows (after GEO fix): 6789\n",
      "Statcounter monthly rows: 6878\n",
      "\n",
      "Merged monthly panel shape: (306593, 9)\n",
      "\n",
      "Non-missing d_infl: 292944\n",
      "Non-missing d_ent : 290295\n",
      "\n",
      "✅ Saved monthly H3 panel to: /Users/ibrahimgozlukaya/Desktop/DSA210/data/processed/panel_monthly_h3.csv\n"
     ]
    }
   ],
   "source": [
    "\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "\n",
    "print(\"RAW:\", DATA_RAW)\n",
    "print(\"PROCESSED:\", DATA_PROCESSED)\n",
    "\n",
    "# ==========================================================\n",
    "# 1) MONTHLY UNEMPLOYMENT  (Eurostat)\n",
    "# ==========================================================\n",
    "unemp = pd.read_csv(DATA_RAW / \"une_rt_m_linear_2_0.csv\")\n",
    "\n",
    "unemp = unemp.rename(columns={\n",
    "    \"TIME_PERIOD\": \"date\",\n",
    "    \"OBS_VALUE\": \"unemployment\",\n",
    "})\n",
    "\n",
    "unemp[\"date\"]  = pd.to_datetime(unemp[\"date\"]).dt.to_period(\"M\").dt.to_timestamp()\n",
    "unemp[\"geo\"]   = unemp[\"geo\"].str.upper()\n",
    "unemp[\"year\"]  = unemp[\"date\"].dt.year\n",
    "unemp[\"month\"] = unemp[\"date\"].dt.month\n",
    "\n",
    "unemp_m = unemp[[\"geo\", \"year\", \"month\", \"unemployment\"]].copy()\n",
    "print(\"Unemployment monthly rows:\", len(unemp_m))\n",
    "\n",
    "# ==========================================================\n",
    "# 2) MONTHLY HICP INDEX  (Eurostat)\n",
    "# ==========================================================\n",
    "hicp = pd.read_csv(DATA_RAW / \"prc_hicp_midx__custom_19134087_linear.csv\")\n",
    "\n",
    "hicp = hicp.rename(columns={\n",
    "    \"geo\": \"geo_name\",\n",
    "    \"TIME_PERIOD\": \"date\",\n",
    "    \"OBS_VALUE\": \"hicp_index\",\n",
    "})\n",
    "\n",
    "hicp[\"date\"]  = pd.to_datetime(hicp[\"date\"]).dt.to_period(\"M\").dt.to_timestamp()\n",
    "hicp[\"year\"]  = hicp[\"date\"].dt.year\n",
    "hicp[\"month\"] = hicp[\"date\"].dt.month\n",
    "\n",
    "# Map verbose country names to Eurostat geo codes\n",
    "name_to_geo = {\n",
    "    \"Albania\": \"AL\",\n",
    "    \"Austria\": \"AT\",\n",
    "    \"Belgium\": \"BE\",\n",
    "    \"Bulgaria\": \"BG\",\n",
    "    \"Croatia\": \"HR\",\n",
    "    \"Cyprus\": \"CY\",\n",
    "    \"Czechia\": \"CZ\",\n",
    "    \"Denmark\": \"DK\",\n",
    "    \"Estonia\": \"EE\",\n",
    "    \"Finland\": \"FI\",\n",
    "    \"France\": \"FR\",\n",
    "    \"Germany\": \"DE\",\n",
    "    \"Greece\": \"EL\",\n",
    "    \"Hungary\": \"HU\",\n",
    "    \"Iceland\": \"IS\",\n",
    "    \"Ireland\": \"IE\",\n",
    "    \"Italy\": \"IT\",\n",
    "    \"Latvia\": \"LV\",\n",
    "    \"Lithuania\": \"LT\",\n",
    "    \"Luxembourg\": \"LU\",\n",
    "    \"Malta\": \"MT\",\n",
    "    \"Montenegro\": \"ME\",\n",
    "    \"Netherlands\": \"NL\",\n",
    "    \"North Macedonia\": \"MK\",\n",
    "    \"Norway\": \"NO\",\n",
    "    \"Poland\": \"PL\",\n",
    "    \"Portugal\": \"PT\",\n",
    "    \"Romania\": \"RO\",\n",
    "    \"Serbia\": \"RS\",\n",
    "    \"Slovenia\": \"SI\",\n",
    "    \"Spain\": \"ES\",\n",
    "    \"Sweden\": \"SE\",\n",
    "    \"Switzerland\": \"CH\",\n",
    "    \"Türkiye\": \"TR\",\n",
    "    \"United Kingdom\": \"UK\",\n",
    "}\n",
    "\n",
    "hicp[\"geo\"] = hicp[\"geo_name\"].map(name_to_geo)\n",
    "hicp = hicp[~hicp[\"geo\"].isna()].copy()\n",
    "\n",
    "print(\"HICP date min:\", hicp[\"year\"].min(), \"HICP date max:\", hicp[\"year\"].max())\n",
    "\n",
    "hicp_m = hicp[[\"geo\", \"year\", \"month\", \"hicp_index\"]].copy()\n",
    "print(\"HICP monthly rows (after GEO fix):\", len(hicp_m))\n",
    "\n",
    "# ==========================================================\n",
    "# 3) STATCOUNTER MONTHLY (merged file from Cell 3)\n",
    "# ==========================================================\n",
    "sc = pd.read_csv(DATA_PROCESSED / \"social_media_countries_monthly.csv\")\n",
    "\n",
    "# infer date column\n",
    "date_col = next(c for c in sc.columns if \"date\" in c.lower() or \"month\" in c.lower())\n",
    "geo_col  = next(c for c in sc.columns if c.lower() in [\"geo\", \"country\", \"region\"])\n",
    "\n",
    "platform_map = {}\n",
    "for c in sc.columns:\n",
    "    lc = c.lower()\n",
    "    if \"facebook\" in lc:  platform_map[\"facebook\"] = c\n",
    "    if \"instagram\" in lc: platform_map[\"instagram\"] = c\n",
    "    if \"youtube\" in lc:   platform_map[\"youtube\"] = c\n",
    "    if \"linkedin\" in lc:  platform_map[\"linkedin\"] = c\n",
    "\n",
    "sc = sc.rename(columns={\n",
    "    date_col: \"date\",\n",
    "    geo_col: \"geo\",\n",
    "    platform_map[\"facebook\"]: \"facebook\",\n",
    "    platform_map[\"instagram\"]: \"instagram\",\n",
    "    platform_map[\"youtube\"]: \"youtube\",\n",
    "    platform_map[\"linkedin\"]: \"linkedin\",\n",
    "})\n",
    "\n",
    "sc[\"date\"]  = pd.to_datetime(sc[\"date\"]).dt.to_period(\"M\").dt.to_timestamp()\n",
    "sc[\"geo\"]   = sc[\"geo\"].str.upper()\n",
    "sc[\"year\"]  = sc[\"date\"].dt.year\n",
    "sc[\"month\"] = sc[\"date\"].dt.month\n",
    "\n",
    "sc_m = sc[[\"geo\", \"year\", \"month\", \"facebook\", \"instagram\", \"youtube\", \"linkedin\"]].copy()\n",
    "print(\"Statcounter monthly rows:\", len(sc_m))\n",
    "\n",
    "# ==========================================================\n",
    "# 4) MERGE ALL MONTHLY DATA\n",
    "# ==========================================================\n",
    "panel_m = (\n",
    "    sc_m\n",
    "    .merge(unemp_m, on=[\"geo\", \"year\", \"month\"], how=\"left\")\n",
    "    .merge(hicp_m,  on=[\"geo\", \"year\", \"month\"], how=\"left\")\n",
    "    .sort_values([\"geo\", \"year\", \"month\"])\n",
    ")\n",
    "\n",
    "print(\"\\nMerged monthly panel shape:\", panel_m.shape)\n",
    "\n",
    "# ==========================================================\n",
    "# 5) PLATFORM CATEGORIES + Δ variables\n",
    "# ==========================================================\n",
    "panel_m[\"ent_share\"]  = panel_m[[\"instagram\", \"facebook\", \"youtube\"]].mean(axis=1)\n",
    "panel_m[\"prof_share\"] = panel_m[\"linkedin\"]\n",
    "\n",
    "panel_m[\"d_unemp\"] = panel_m.groupby(\"geo\")[\"unemployment\"].diff()\n",
    "panel_m[\"d_infl\"]  = panel_m.groupby(\"geo\")[\"hicp_index\"].diff()\n",
    "panel_m[\"d_ent\"]   = panel_m.groupby(\"geo\")[\"ent_share\"].diff()\n",
    "panel_m[\"d_prof\"]  = panel_m.groupby(\"geo\")[\"prof_share\"].diff()\n",
    "\n",
    "print(\"\\nNon-missing d_infl:\", panel_m[\"d_infl\"].notna().sum())\n",
    "print(\"Non-missing d_ent :\", panel_m[\"d_ent\"].notna().sum())\n",
    "\n",
    "out_m = DATA_PROCESSED / \"panel_monthly_h3.csv\"\n",
    "panel_m.to_csv(out_m, index=False)\n",
    "print(\"\\n✅ Saved monthly H3 panel to:\", out_m)\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "17c1f369",
   "metadata": {},
   "source": [
    "## CELL 5 – Build annual macro + participation panel (H1 & H2)\n",
    "\n",
    "This cell:\n",
    "1. Loads Eurostat social-media participation (`tin00127_linear_2_0.csv`).\n",
    "2. Uses HICP (same file as above) to compute annual inflation (Dec/Dec).\n",
    "3. Aggregates monthly unemployment to annual averages.\n",
    "4. Aggregates OECD CCI to annual averages.\n",
    "5. Merges everything into a single `panel_annual.csv` in `data/processed/`."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "8b0fd3c8",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tin00127 annual rows: 424\n",
      "Annual inflation rows: 539\n",
      "Annual unemployment rows: 1219\n",
      "Annual CCI rows: 384\n",
      "Final annual panel shape: (423, 6)\n",
      "Columns: ['geo', 'year', 'sm_participation', 'inflation', 'unemployment_rate', 'cci']\n",
      "\n",
      "✅ Saved annual panel to: /Users/ibrahimgozlukaya/Desktop/DSA210/data/processed/panel_annual.csv\n"
     ]
    }
   ],
   "source": [
    "\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "\n",
    "# ------------------------------------------------\n",
    "# 1) Social-media participation (Eurostat tin00127)\n",
    "# ------------------------------------------------\n",
    "tin = pd.read_csv(DATA_RAW / \"tin00127_linear_2_0.csv\")\n",
    "\n",
    "tin = tin.rename(columns={\n",
    "    \"TIME_PERIOD\": \"year\",\n",
    "    \"OBS_VALUE\": \"sm_participation\",\n",
    "})\n",
    "\n",
    "tin[\"year\"] = tin[\"year\"].astype(int)\n",
    "tin[\"geo\"]  = tin[\"geo\"].str.upper()\n",
    "\n",
    "tin = tin[[\"geo\", \"year\", \"sm_participation\"]].copy()\n",
    "print(\"tin00127 annual rows:\", len(tin))\n",
    "\n",
    "# ------------------------------------------------\n",
    "# 2) Annual inflation from HICP (Dec/Dec % change)\n",
    "# ------------------------------------------------\n",
    "# Re-use hicp_m logic from Cell 4 by reading the same raw file\n",
    "hicp_raw = pd.read_csv(DATA_RAW / \"prc_hicp_midx__custom_19134087_linear.csv\")\n",
    "\n",
    "hicp = hicp_raw.rename(columns={\n",
    "    \"geo\": \"geo_name\",\n",
    "    \"TIME_PERIOD\": \"date\",\n",
    "    \"OBS_VALUE\": \"hicp_index\",\n",
    "})\n",
    "\n",
    "hicp[\"date\"]  = pd.to_datetime(hicp[\"date\"])\n",
    "hicp[\"year\"]  = hicp[\"date\"].dt.year\n",
    "hicp[\"month\"] = hicp[\"date\"].dt.month\n",
    "\n",
    "hicp[\"geo\"] = hicp[\"geo_name\"].map(name_to_geo)\n",
    "hicp = hicp[~hicp[\"geo\"].isna()].copy()\n",
    "\n",
    "december = hicp[hicp[\"month\"] == 12].copy()\n",
    "december = december.sort_values([\"geo\", \"year\"])\n",
    "december[\"inflation\"] = december.groupby(\"geo\")[\"hicp_index\"].pct_change() * 100.0\n",
    "\n",
    "inflation_annual = december[[\"geo\", \"year\", \"inflation\"]].copy()\n",
    "print(\"Annual inflation rows:\", len(inflation_annual))\n",
    "\n",
    "# ------------------------------------------------\n",
    "# 3) Annual unemployment (mean of monthly values)\n",
    "# ------------------------------------------------\n",
    "unemp_raw = pd.read_csv(DATA_RAW / \"une_rt_m_linear_2_0.csv\")\n",
    "\n",
    "unemp = unemp_raw.rename(columns={\n",
    "    \"TIME_PERIOD\": \"date\",\n",
    "    \"OBS_VALUE\": \"unemployment\",\n",
    "})\n",
    "\n",
    "unemp[\"date\"] = pd.to_datetime(unemp[\"date\"])\n",
    "unemp[\"year\"] = unemp[\"date\"].dt.year\n",
    "unemp[\"geo\"]  = unemp[\"geo\"].str.upper()\n",
    "\n",
    "unemp_annual = (\n",
    "    unemp.groupby([\"geo\", \"year\"], as_index=False)[\"unemployment\"]\n",
    "    .mean()\n",
    "    .rename(columns={\"unemployment\": \"unemployment_rate\"})\n",
    ")\n",
    "\n",
    "print(\"Annual unemployment rows:\", len(unemp_annual))\n",
    "\n",
    "# ------------------------------------------------\n",
    "# 4) Annual CCI (OECD export, semicolon separated)\n",
    "# ------------------------------------------------\n",
    "cci_wide = pd.read_csv(\n",
    "    DATA_RAW / \"export-2025-11-26T13_03_48.204Z.csv\",\n",
    "    sep=\";\",\n",
    "    skiprows=2,\n",
    "    decimal=\",\",\n",
    ")\n",
    "\n",
    "cci_wide = cci_wide.rename(columns={\"Category\": \"date\"})\n",
    "cci_wide[\"date\"] = pd.to_datetime(cci_wide[\"date\"])\n",
    "cci_wide[\"year\"] = cci_wide[\"date\"].dt.year\n",
    "\n",
    "cci_name_to_geo = {\n",
    "    \"Austria\": \"AT\",\n",
    "    \"Belgium\": \"BE\",\n",
    "    \"Czechia\": \"CZ\",\n",
    "    \"Denmark\": \"DK\",\n",
    "    \"Estonia\": \"EE\",\n",
    "    \"Finland\": \"FI\",\n",
    "    \"France\": \"FR\",\n",
    "    \"Germany\": \"DE\",\n",
    "    \"Greece\": \"EL\",\n",
    "    \"Hungary\": \"HU\",\n",
    "    \"Iceland\": \"IS\",\n",
    "    \"Ireland\": \"IE\",\n",
    "    \"Italy\": \"IT\",\n",
    "    \"Latvia\": \"LV\",\n",
    "    \"Lithuania\": \"LT\",\n",
    "    \"Luxembourg\": \"LU\",\n",
    "    \"Netherlands\": \"NL\",\n",
    "    \"Norway\": \"NO\",\n",
    "    \"Poland\": \"PL\",\n",
    "    \"Portugal\": \"PT\",\n",
    "    \"Slovak Republic\": \"SK\",\n",
    "    \"Slovenia\": \"SI\",\n",
    "    \"Spain\": \"ES\",\n",
    "    \"Sweden\": \"SE\",\n",
    "    \"Switzerland\": \"CH\",\n",
    "    \"Türkiye\": \"TR\",\n",
    "    \"United Kingdom\": \"UK\",\n",
    "}\n",
    "\n",
    "cci_long_frames = []\n",
    "for country_name, geo in cci_name_to_geo.items():\n",
    "    if country_name not in cci_wide.columns:\n",
    "        continue\n",
    "    tmp = cci_wide[[\"year\", country_name]].copy()\n",
    "    tmp = tmp.rename(columns={country_name: \"cci\"})\n",
    "    tmp[\"geo\"] = geo\n",
    "    cci_long_frames.append(tmp)\n",
    "\n",
    "cci_long = pd.concat(cci_long_frames, ignore_index=True)\n",
    "cci_annual = (\n",
    "    cci_long.groupby([\"geo\", \"year\"], as_index=False)[\"cci\"]\n",
    "    .mean()\n",
    ")\n",
    "\n",
    "print(\"Annual CCI rows:\", len(cci_annual))\n",
    "\n",
    "# ------------------------------------------------\n",
    "# 5) Merge all annual components\n",
    "# ------------------------------------------------\n",
    "panel_a = (\n",
    "    tin.merge(inflation_annual, on=[\"geo\", \"year\"], how=\"left\")\n",
    "       .merge(unemp_annual,     on=[\"geo\", \"year\"], how=\"left\")\n",
    "       .merge(cci_annual,       on=[\"geo\", \"year\"], how=\"left\")\n",
    ")\n",
    "\n",
    "# Optional: restrict to years where we have SM participation\n",
    "panel_a = panel_a.dropna(subset=[\"sm_participation\"]).copy()\n",
    "\n",
    "print(\"Final annual panel shape:\", panel_a.shape)\n",
    "print(\"Columns:\", panel_a.columns.tolist())\n",
    "\n",
    "out_a = DATA_PROCESSED / \"panel_annual.csv\"\n",
    "panel_a.to_csv(out_a, index=False)\n",
    "print(\"\\n✅ Saved annual panel to:\", out_a)\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "95942b8c",
   "metadata": {},
   "source": [
    "## CELL 6 – Add economic stress index and ΔSM\n",
    "\n",
    "This optional cell reloads `panel_annual.csv`, computes the combined\n",
    "economic stress index and the year-on-year change in social-media\n",
    "participation, and overwrites `panel_annual.csv` with these extra\n",
    "columns. This is convenient for EDA and hypothesis testing notebooks."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "36c43021",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Saved annual panel with d_sm + stress to: /Users/ibrahimgozlukaya/Desktop/DSA210/data/processed/panel_annual.csv\n",
      "  geo  year  sm_participation  inflation  unemployment_rate  cci  stress\n",
      "0  AL  2018             48.33        NaN                NaN  NaN     NaN\n",
      "1  AL  2019             52.13        NaN                NaN  NaN     NaN\n",
      "2  AL  2020             54.80        NaN                NaN  NaN     NaN\n",
      "3  AL  2021             60.77        NaN                NaN  NaN     NaN\n",
      "4  AL  2022             64.07        NaN                NaN  NaN     NaN\n"
     ]
    }
   ],
   "source": [
    "\n",
    "import pandas as pd\n",
    "from pathlib import Path\n",
    "\n",
    "panel_a = pd.read_csv(DATA_PROCESSED / \"panel_annual.csv\")\n",
    "panel_a = panel_a.sort_values([\"geo\", \"year\"]).copy()\n",
    "\n",
    "# ΔSM (year-on-year change)\n",
    "panel_a[\"d_sm\"] = panel_a.groupby(\"geo\")[\"sm_participation\"].diff()\n",
    "\n",
    "# Standardise macro variables\n",
    "for col, new in [(\"inflation\", \"infl_z\"),\n",
    "                 (\"unemployment_rate\", \"unemp_z\"),\n",
    "                 (\"cci\", \"cci_z\")]:\n",
    "    if col in panel_a.columns:\n",
    "        panel_a[new] = (panel_a[col] - panel_a[col].mean()) / panel_a[col].std()\n",
    "\n",
    "# Economic stress index: higher = more stress\n",
    "panel_a[\"stress\"] = panel_a[\"infl_z\"] + panel_a[\"unemp_z\"] - panel_a[\"cci_z\"]\n",
    "\n",
    "out_a = DATA_PROCESSED / \"panel_annual.csv\"\n",
    "panel_a.to_csv(out_a, index=False)\n",
    "\n",
    "print(\"Saved annual panel with d_sm + stress to:\", out_a)\n",
    "print(panel_a[[\"geo\",\"year\",\"sm_participation\",\"inflation\",\"unemployment_rate\",\"cci\",\"stress\"]].head())\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": ".venv",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.12"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
